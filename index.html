<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Inventario John Silver - Sistema Premium</title>
    <!-- QuaggaJS para escaneo de c√≥digos de barras -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <!-- Chart.js para gr√°ficas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e293b;
            --primary-dark: #0f172a;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --border: #e2e8f0;
            --bg: #f8fafc;
            --text: #1e293b;
            --text-light: #64748b;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius: 0.75rem;
            --radius-lg: 1rem;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .animate-in {
            animation: fadeIn 0.3s ease;
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-top {
            padding: 0.75rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo {
            width: 42px;
            height: 42px;
            border-radius: var(--radius);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .logo:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .logo-upload {
            display: none;
        }

        .brand-name {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .operator-input {
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .operator-input:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30,41,59,0.1);
        }

        .operator-input input {
            border: none;
            outline: none;
            width: 140px;
            font-size: 0.875rem;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            border: 2px solid var(--border);
            background: white;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }

        .btn-outline-danger {
            color: var(--danger);
            border-color: var(--danger);
            background: white;
        }

        .btn-outline-danger:hover {
            background: #fef2f2;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            padding: 0;
            border-top: 1px solid var(--border);
            background: white;
            overflow-x: auto;
        }

        .tab {
            padding: 0.75rem 1.25rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
            transition: all 0.2s;
            white-space: nowrap;
            font-weight: 500;
            position: relative;
        }

        .tab:hover {
            color: var(--text);
            background: var(--bg);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--bg);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
            box-shadow: var(--shadow);
            animation: fadeIn 0.4s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card.clickable {
            cursor: pointer;
        }

        .stat-icon-wrapper {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
        }

        .stat-content {
            flex: 1;
            min-width: 0;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stat-icon {
            font-size: 1.5rem;
            opacity: 0.8;
        }

        /* Model Summary */
        .model-summary {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin: 1rem 0;
            box-shadow: var(--shadow);
        }

        .model-summary-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .model-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            position: relative;
        }

        .model-tag {
            padding: 0.5rem 1rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg);
            font-size: 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .model-tag:hover {
            background: white;
            border-color: var(--primary);
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }
        
        .model-tag:active {
            transform: scale(0.98);
        }
        
        .model-tag.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.2);
            font-weight: 600;
        }
        
        .model-tag.active strong {
            color: white;
        }

        /* Scan Panel */
        .scan-panel {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s ease;
        }

        .scan-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
            font-weight: 600;
            color: var(--primary);
        }

        .scan-form {
            display: grid;
            gap: 1rem;
        }

        .scan-row {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 0.5rem;
            align-items: end;
            flex-wrap: wrap;
        }

        .input-group {
            position: relative;
        }

        .input-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            outline: none;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .input-group input:focus,
        .input-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30,41,59,0.1);
        }

        .input-icon {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }

        .input-group.with-icon input {
            padding-left: 2.75rem;
        }
        
        /* Desactivar autocompletado visual del navegador */
        #barcodeInput::-webkit-contacts-auto-fill-button,
        #barcodeInput::-webkit-credentials-auto-fill-button {
            visibility: hidden;
            display: none !important;
            pointer-events: none;
            height: 0;
            width: 0;
            margin: 0;
        }
        
        #barcodeInput::-ms-clear,
        #barcodeInput::-ms-reveal {
            display: none;
            width: 0;
            height: 0;
        }
        
        #barcodeInput::-webkit-search-decoration,
        #barcodeInput::-webkit-search-cancel-button,
        #barcodeInput::-webkit-search-results-button,
        #barcodeInput::-webkit-search-results-decoration {
            display: none;
        }
        
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px white inset !important;
            -webkit-text-fill-color: inherit !important;
            transition: background-color 5000s ease-in-out 0s;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 0.875rem;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-group:hover {
            border-color: var(--primary);
            background: white;
        }

        .checkbox-group input[type="checkbox"] {
            cursor: pointer;
        }

        /* Scanner de c√°mara m√≥vil */
        .mobile-scanner-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: var(--radius);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .mobile-scanner-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .mobile-scanner-btn:active {
            transform: translateY(0);
        }

        .mobile-scanner-btn .icon {
            font-size: 1rem;
        }

        /* Camera Scanner Modal */
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            overflow: hidden;
        }

        .scanner-modal.active {
            display: block;
        }

        .scanner-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .scanner-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            color: white;
            padding: 1rem;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scanner-close {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        #scanner-viewport {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        #scanner-viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #scanner-viewport canvas {
            display: none;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 300px;
            height: 200px;
            border: 3px solid #10b981;
            border-radius: var(--radius);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.5);
            animation: pulse 2s infinite;
            pointer-events: none;
        }

        .scanner-overlay::before,
        .scanner-overlay::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #10b981;
        }

        .scanner-overlay::before {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
        }

        .scanner-overlay::after {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
        }

        .scanner-status {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            padding: 2rem 1rem;
            text-align: center;
            z-index: 10;
        }

        .scanner-status-text {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .scanner-status-code {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
            font-family: monospace;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: var(--radius);
            display: inline-block;
            margin-top: 0.5rem;
        }

        /* Products Table */
        .products-section {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin: 1rem 0;
            animation: fadeIn 0.4s ease;
        }

        .products-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            background: var(--bg);
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            padding: 0.5rem 0.875rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            outline: none;
            min-width: 200px;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30,41,59,0.1);
        }

        .filter-btn {
            padding: 0.5rem 0.875rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: white;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        .filter-btn:hover {
            background: var(--bg);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg);
        }

        th {
            padding: 0.875rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 0.875rem;
            border-bottom: 1px solid var(--border);
        }

        tbody tr {
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: var(--bg);
        }

        .model-header {
            background: linear-gradient(to right, #f8fafc, transparent);
            font-weight: 600;
            color: var(--primary);
        }

        .product-image {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            object-fit: cover;
        }

        .product-image-placeholder {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
        }

        .stock-badge {
            padding: 0.25rem 0.625rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .stock-zero {
            background: #fef2f2;
            color: #ef4444;
        }

        .stock-low {
            background: #fef3c7;
            color: #f59e0b;
        }

        .stock-ok {
            background: #d1fae5;
            color: #10b981;
        }

        .action-buttons {
            display: flex;
            gap: 0.375rem;
            justify-content: flex-end;
        }

        .action-btn {
            padding: 0.375rem 0.625rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            font-weight: 500;
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow);
        }

        .action-btn.plus {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .action-btn.minus {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--border);
            color: var(--text);
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30,41,59,0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Notifications */
        .notifications {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .notification {
            background: white;
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 280px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification.info {
            border-left-color: var(--info);
        }

        .notification-icon {
            font-size: 1.25rem;
        }

        .notification-message {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text);
        }

        .notification-close {
            margin-left: auto;
            cursor: pointer;
            opacity: 0.6;
            font-size: 1.25rem;
            transition: opacity 0.2s;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            padding: 3rem;
            text-align: center;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        /* RFID Section */
        #rfidSection {
            animation: fadeIn 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .scan-row {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .filters {
                width: 100%;
            }
            
            .search-input {
                width: 100%;
            }

            .model-tags {
                gap: 0.25rem;
            }

            .model-tag {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }

            .mobile-scanner-btn {
                font-size: 0.8rem;
                padding: 0.75rem 1rem;
                flex: 1;
                min-width: 150px;
            }
            
            .scan-panel button[type="submit"] {
                flex: 1;
                min-width: 150px;
            }
            
            /* Analytics responsive */
            #analyticsContent > div > div {
                grid-template-columns: 1fr !important;
            }
        }

        /* Charts */
        canvas {
            max-height: 300px;
            min-height: 200px;
        }

        /* Utilities */
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-top">
                <div class="logo-section">
                    <label class="logo">
                        <span id="logoPlaceholder">üè™</span>
                        <img id="logoImg" style="display: none;" alt="Logo">
                        <input type="file" class="logo-upload" accept="image/*" onchange="handleLogoUpload(event)">
                    </label>
                    <div class="brand-name">
                        <span>üì¶</span>
                        <span>Inventario John Silver</span>
                    </div>
                </div>
                
                <div class="header-actions">
                    <div class="operator-input">
                        <span>üë§</span>
                        <input type="text" id="operatorInput" placeholder="Operador">
                    </div>
                    <button class="btn btn-primary" onclick="openAddModal()">
                        <span>‚ûï</span> Nuevo
                    </button>
                    <button class="btn" onclick="exportProductsCSV()">
                        <span>üìä</span> Exportar CSV
                    </button>
                    <button class="btn" onclick="exportMovementsCSV()">
                        <span>üìã</span> Movimientos
                    </button>
                    <button class="btn" onclick="exportJSON()">
                        <span>üíæ</span> Respaldo
                    </button>
                    <button class="btn" onclick="openBulkModal()">
                        <span>üì§</span> Carga masiva
                    </button>
                    <button class="btn btn-outline-danger" onclick="clearAll()">
                        <span>üîí</span> Vaciar
                    </button>
                    <button class="btn" onclick="toggleValues()">
                        <span id="valuesIcon">üëÅÔ∏è</span>
                        <span id="valuesText">Ver datos</span>
                    </button>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="setTab('entradas', this)" data-tab="entradas">
                    <span>‚¨áÔ∏è</span> Entradas
                </button>
                <button class="tab" onclick="setTab('salidas', this)" data-tab="salidas">
                    <span>‚¨ÜÔ∏è</span> Salidas
                </button>
                <button class="tab" onclick="setTab('productos', this)" data-tab="productos">
                    <span>üì¶</span> Productos
                </button>
                <button class="tab" onclick="setTab('movimientos', this)" data-tab="movimientos">
                    <span>üìã</span> Movimientos
                </button>
                <button class="tab" onclick="setTab('analytics', this)" data-tab="analytics">
                    <span>üìä</span> Analytics
                    <span style="font-size: 0.7rem; margin-left: 0.25rem;">üîí</span>
                </button>
                <button class="tab" onclick="setTab('herramientas', this)" data-tab="herramientas">
                    <span>‚öôÔ∏è</span> Herramientas
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card animate-in">
                <div class="stat-icon-wrapper">
                    <span class="stat-icon">üì¶</span>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Productos</div>
                    <div class="stat-value" id="statProducts">0</div>
                </div>
            </div>
            <div class="stat-card animate-in" style="animation-delay: 0.1s;">
                <div class="stat-icon-wrapper">
                    <span class="stat-icon">üëñ</span>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Unidades Totales</div>
                    <div class="stat-value" id="statUnits">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                </div>
            </div>
            <div class="stat-card clickable animate-in" onclick="toggleValues()" style="animation-delay: 0.2s;">
                <div class="stat-icon-wrapper">
                    <span class="stat-icon">üí∞</span>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Valor Total</div>
                    <div class="stat-value" id="statValue">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                </div>
            </div>
            <div class="stat-card clickable animate-in" onclick="showLowStock()" style="animation-delay: 0.3s;">
                <div class="stat-icon-wrapper">
                    <span class="stat-icon" id="lowStockIcon">‚ö†Ô∏è</span>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Stock Bajo</div>
                    <div class="stat-value" id="statLowStock">0</div>
                </div>
            </div>
        </div>

        <!-- Model Summary -->
        <div id="modelSummary" class="model-summary" style="display: none;">
            <div class="model-summary-header">
                <span>üè∑Ô∏è</span>
                <span>Resumen por modelo</span>
            </div>
            <div class="model-tags" id="modelTags"></div>
        </div>

        <!-- Scan Panel -->
        <div id="scanPanel" class="scan-panel">
            <div class="scan-header">
                <span>üì∏</span>
                <span id="scanTitle">Entradas ‚Ä¢ Escaneo r√°pido</span>
            </div>
            <form class="scan-form" onsubmit="processScan(event)" autocomplete="off">
                <div class="scan-row">
                    <div class="input-group with-icon">
                        <label class="input-label">C√≥digo de barras, QR o RFID</label>
                        <span class="input-icon">|||||</span>
                        <input type="search" 
                               id="barcodeInput" 
                               placeholder="Escanea o escribe..." 
                               autocomplete="new-password" 
                               autocorrect="off" 
                               autocapitalize="off" 
                               spellcheck="false"
                               data-form-type="other"
                               data-lpignore="true"
                               data-1p-ignore="true"
                               aria-autocomplete="none"
                               autofocus>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Tipo</label>
                        <select id="scanType" disabled>
                            <option value="entrada">Entrada</option>
                            <option value="salida">Salida</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Cantidad</label>
                        <input type="number" id="scanQty" value="1" min="1" style="width: 100px;">
                    </div>
                    <label class="checkbox-group">
                        <input type="checkbox" id="autoPlus" checked>
                        <span>Auto +1</span>
                    </label>
                </div>
                <div class="scan-row">
                    <div class="input-group">
                        <label class="input-label">Plataforma de venta</label>
                        <select id="platformSelect">
                            <option value="">(Sin plataforma)</option>
                        </select>
                    </div>
                    <label class="checkbox-group">
                        <input type="checkbox" id="addTracking">
                        <span>üì¶ A√±adir gu√≠a</span>
                    </label>
                    <label class="checkbox-group" id="returnGroup">
                        <input type="checkbox" id="isReturn">
                        <span>üîÑ Es devoluci√≥n</span>
                    </label>
                    <label class="checkbox-group" id="noGuideGroup" style="display: none;">
                        <input type="checkbox" id="noGuide">
                        <span>‚ùå Sin gu√≠a</span>
                    </label>
                </div>
                
                <!-- Botones de escaneo y registro -->
                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
                    <button type="button" class="mobile-scanner-btn" onclick="openMobileScanner()">
                        <span class="icon">üì±</span>
                        <span>Escanear con C√°mara</span>
                    </button>
                    <button type="submit" class="btn btn-success">
                        <span id="scanIcon">‚¨áÔ∏è</span>
                        Registrar movimiento manual
                    </button>
                    <div id="pendingGuide" style="display: none; padding: 0.625rem; background: #d1fae5; border-radius: 0.5rem; color: #10b981; flex: 1;">
                        ‚úÖ Gu√≠a lista: <strong id="pendingGuideText"></strong>
                    </div>
                </div>
                
                <div class="scan-row">
                    <div style="width: 100%; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.5rem;">
                        <strong>Otros m√©todos de escaneo:</strong> Opciones adicionales seg√∫n tu hardware
                    </div>
                </div>
                <div class="scan-row">
                    <label class="checkbox-group" style="background: #e0e7ff; border-color: #6366f1;">
                        <input type="checkbox" id="useRFID" onchange="toggleRFID()">
                        <span>üì° Lector RFID/NFC (USB)</span>
                    </label>
                </div>
                
                <!-- Secci√≥n RFID -->
                <div id="rfidSection" style="display: none; margin-top: 1rem;">
                    <div style="padding: 1rem; background: #e0e7ff; border-radius: var(--radius); border: 2px solid #6366f1;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #4f46e5;">üì° Modo Lector RFID/NFC Activo</h4>
                        <div style="font-size: 0.875rem; line-height: 1.5;">
                            <strong>üìå Instrucciones:</strong><br>
                            1. ‚úÖ Aseg√∫rate de que tu lector RFID est√© conectado por USB<br>
                            2. üñ±Ô∏è Click en el campo de c√≥digo de barras arriba<br>
                            3. üè∑Ô∏è Acerca la etiqueta RFID/NFC al lector<br>
                            4. üìù El c√≥digo aparecer√° autom√°ticamente en el campo<br>
                            5. ‚èé Presiona Enter o click en "Registrar movimiento"<br><br>
                            
                            <strong>üîå Lectores compatibles:</strong><br>
                            ‚Ä¢ Cualquier lector USB que emule teclado (HID)<br>
                            ‚Ä¢ RC522 con Arduino (configurado como teclado)<br>
                            ‚Ä¢ ACR122U, ACR1252U (plug & play)<br>
                            ‚Ä¢ Impinj, Zebra, Honeywell (profesionales)<br>
                            ‚Ä¢ Pistolas RFID con cable USB<br><br>
                            
                            <div style="background: white; padding: 0.5rem; border-radius: 0.5rem;">
                                üí° <strong>Tip:</strong> La mayor√≠a de lectores RFID USB funcionan como un teclado. 
                                Si tu lector no funciona, verifica que est√© en modo "Keyboard Emulation" o "HID".
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <p style="font-size: 0.875rem; color: var(--text-light); margin-top: 1rem;">
                üí° <strong>Tips:</strong><br>
                ‚Ä¢ Usa el bot√≥n morado para escanear con la c√°mara del m√≥vil<br>
                ‚Ä¢ Si la c√°mara no funciona, prueba con Chrome o Edge (mejor compatibilidad)<br>
                ‚Ä¢ Tambi√©n puedes escribir manualmente el c√≥digo sin necesidad de esc√°ner<br>
                ‚Ä¢ La plataforma y gu√≠a se guardan en cada movimiento para trazabilidad<br>
                ‚Ä¢ Con pistola l√°ser USB: solo apunta y dispara, no necesitas activar nada
            </p>
        </div>

        <!-- Products Section -->
        <div id="productsSection" class="products-section" style="display: none;">
            <div class="products-header">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>üîç</span>
                    <strong>Productos</strong>
                    <span id="productsCount" style="font-size: 0.875rem; color: var(--text-light);">(0 total)</span>
                </div>
                <div class="filters">
                    <input type="text" class="search-input" id="searchInput" placeholder="Buscar...">
                    <button class="filter-btn active" onclick="setColorFilter('all')">
                        <span>üé®</span> Todos colores
                    </button>
                    <div id="colorFilters"></div>
                    <button class="filter-btn active" onclick="setModelFilter('all')" id="modelFilterAll">
                        <span>üëî</span> Todos modelos
                    </button>
                    <div id="modelFilters"></div>
                    <button class="filter-btn" onclick="setBarcodeFilter()" id="barcodeFilterBtn">
                        <span>üö´</span> Sin c√≥digo
                    </button>
                    <button class="filter-btn" onclick="setLowStockFilter()" id="lowStockFilterBtn">
                        <span>‚ö†Ô∏è</span> Stock bajo
                    </button>
                    <button class="btn" onclick="clearAllFilters()" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;">
                        <span>üîÑ</span> Limpiar filtros
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Modelo</th>
                            <th>C√≥digo</th>
                            <th>Nombre</th>
                            <th>Color</th>
                            <th>Talla</th>
                            <th>Precio</th>
                            <th>Stock M√≠n.</th>
                            <th>Stock</th>
                            <th>Plataforma</th>
                            <th>Gu√≠a</th>
                            <th style="text-align: right;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Movements Section -->
        <div id="movementsSection" class="products-section" style="display: none;">
            <div class="products-header">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>üìã</span>
                    <strong>Movimientos</strong>
                    <span id="movementsCount" style="font-size: 0.875rem; color: var(--text-light);">(0 total)</span>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha y Hora</th>
                            <th>C√≥digo</th>
                            <th>Producto</th>
                            <th>Talla</th>
                            <th>Color</th>
                            <th>Modelo</th>
                            <th>Tipo</th>
                            <th style="text-align: right;">Cantidad</th>
                            <th>Operador</th>
                            <th>Plataforma</th>
                            <th>Gu√≠a</th>
                            <th>Devoluci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="movementsTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tools Section -->
        <div id="toolsSection" class="products-section" style="display: none;">
            <div style="padding: 1.5rem;">
                <h3 style="margin-bottom: 1.5rem; color: var(--primary);">‚öôÔ∏è Herramientas y Configuraci√≥n</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="margin-bottom: 1rem; color: var(--text);">üì± Plataformas de venta</h4>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" id="newPlatform" placeholder="Nueva plataforma (ej: Shein, MercadoLibre)" class="form-input">
                            <button class="btn btn-primary" onclick="addPlatform()">Agregar</button>
                        </div>
                        <div id="platformsList"></div>
                        
                        <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--text);">üìÖ Cierre Mensual</h4>
                        <div style="background: #f0f9ff; padding: 1rem; border-radius: var(--radius); border: 2px solid #3b82f6;">
                            <p style="font-size: 0.875rem; margin-bottom: 1rem;">
                                <strong>üîí Sistema de Cierre Mensual</strong><br>
                                Archiva movimientos del mes y optimiza el rendimiento.
                            </p>
                            <button class="btn btn-warning" onclick="openMonthlyClose()">
                                <span>üìä</span> Cerrar Mes Actual
                            </button>
                            <div id="lastCloseInfo" style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-light);"></div>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 1rem; color: var(--text);">üîê Seguridad</h4>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="password" id="adminPassword" placeholder="Contrase√±a de administraci√≥n" class="form-input">
                            <button class="btn" onclick="savePassword()">Guardar</button>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-light);">
                            Esta contrase√±a protege: valores, unidades, analytics, cierres mensuales y acciones cr√≠ticas.
                        </p>
                        <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--text);">üìä Exportaci√≥n de datos</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <button class="btn" onclick="downloadCSVTemplate()">
                                <span>üìù</span> Plantilla CSV
                            </button>
                            <button class="btn" onclick="exportJSON()">
                                <span>üíæ</span> Respaldo completo JSON
                            </button>
                        </div>
                        
                        <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--text);">üîî Configuraci√≥n de Alertas</h4>
                        <div style="background: var(--bg); padding: 0.75rem; border-radius: var(--radius);">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="alertsEnabled" checked onchange="toggleAlerts()">
                                <span>Activar alertas de stock bajo</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>Alertar cuando queden menos de:</span>
                                <input type="number" id="alertThreshold" value="5" min="1" style="width: 60px;" onchange="updateAlertThreshold()">
                                <span>unidades</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section (Protected) -->
        <div id="analyticsSection" class="products-section" style="display: none;">
            <div style="padding: 1.5rem;">
                <div id="analyticsLocked" style="text-align: center; padding: 4rem 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üîí</div>
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">√Årea Protegida</h3>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Analytics requiere contrase√±a de administrador para acceder
                    </p>
                    <button class="btn btn-primary" onclick="unlockAnalytics()">
                        <span>üîì</span> Desbloquear Analytics
                    </button>
                </div>
                
                <div id="analyticsContent" style="display: none;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary);">
                        üìä Analytics y M√©tricas
                        <button class="btn" onclick="lockAnalytics()" style="float: right; font-size: 0.875rem;">
                            <span>üîí</span> Bloquear
                        </button>
                    </h3>
                    
                    <!-- Resumen de m√©tricas -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-icon-wrapper">
                                <span class="stat-icon">üìà</span>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Ventas del Mes</div>
                                <div class="stat-value" id="monthSales">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon-wrapper">
                                <span class="stat-icon">üí∞</span>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Valor Vendido</div>
                                <div class="stat-value" id="monthRevenue">$0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon-wrapper">
                                <span class="stat-icon">üì¶</span>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Rotaci√≥n Promedio</div>
                                <div class="stat-value" id="avgRotation">0%</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon-wrapper">
                                <span class="stat-icon">‚ö°</span>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Producto Estrella</div>
                                <div class="stat-value" id="topProduct" style="font-size: 1rem;">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gr√°ficas -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow);">
                            <h4 style="margin-bottom: 1rem; color: var(--text);">üìä Movimientos Diarios (√öltimos 30 d√≠as)</h4>
                            <canvas id="dailyMovementsChart"></canvas>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow);">
                            <h4 style="margin-bottom: 1rem; color: var(--text);">ü•á Top 10 Productos M√°s Vendidos</h4>
                            <canvas id="topProductsChart"></canvas>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow);">
                            <h4 style="margin-bottom: 1rem; color: var(--text);">üìà Tendencia de Inventario</h4>
                            <canvas id="inventoryTrendChart"></canvas>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow);">
                            <h4 style="margin-bottom: 1rem; color: var(--text);">üè∑Ô∏è Distribuci√≥n por Categor√≠as</h4>
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Alertas de Stock -->
                    <div style="margin-top: 2rem; background: white; padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow);">
                        <h4 style="margin-bottom: 1rem; color: var(--text);">
                            üîî Alertas de Stock Cr√≠tico
                            <span id="alertCount" style="background: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 999px; font-size: 0.75rem; margin-left: 0.5rem;">0</span>
                        </h4>
                        <div id="stockAlertsList"></div>
                    </div>
                    
                    <!-- Sincronizaci√≥n -->
                    <div style="margin-top: 2rem; background: white; padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow);">
                        <h4 style="margin-bottom: 1rem; color: var(--text);">üì± Sincronizaci√≥n Entre Dispositivos</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <h5 style="margin-bottom: 0.5rem;">üì§ Exportar para Sincronizar</h5>
                                <button class="btn btn-primary" onclick="generateSyncCode()">
                                    Generar C√≥digo de Sincronizaci√≥n
                                </button>
                                <div id="syncCodeDisplay" style="margin-top: 0.5rem; padding: 0.75rem; background: var(--bg); border-radius: var(--radius); font-family: monospace; display: none;"></div>
                            </div>
                            <div>
                                <h5 style="margin-bottom: 0.5rem;">üì• Importar de Otro Dispositivo</h5>
                                <input type="text" id="syncCodeInput" placeholder="Pegar c√≥digo de sincronizaci√≥n" class="form-input" style="margin-bottom: 0.5rem;">
                                <button class="btn" onclick="importSyncCode()">
                                    Sincronizar Datos
                                </button>
                            </div>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-light); margin-top: 1rem;">
                            üí° El c√≥digo de sincronizaci√≥n contiene todos los datos comprimidos. C√≥pialo y p√©galo en otro dispositivo para sincronizar.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scanner Modal -->
    <div id="scannerModal" class="scanner-modal">
        <div class="scanner-container">
            <div class="scanner-header">
                <h3 style="margin: 0; font-size: 1.25rem;">üì± Esc√°ner de C√≥digos</h3>
                <button class="scanner-close" onclick="closeMobileScanner()">‚úï Cerrar</button>
            </div>
            
            <div id="scanner-viewport">
                <div class="scanner-overlay"></div>
            </div>
            
            <div class="scanner-status">
                <div class="scanner-status-text" id="scannerStatusText">
                    üîç Apunta la c√°mara al c√≥digo de barras o QR
                </div>
                <div id="scannerResult" style="display: none;">
                    <div class="scanner-status-code" id="scannerResultCode"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ûï Nuevo Producto</h3>
                <button class="modal-close" onclick="closeModal('addModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="productForm" onsubmit="saveProduct(event)">
                    <div class="form-group">
                        <label class="form-label">C√≥digo de barras</label>
                        <input type="text" id="modalBarcode" class="form-input" placeholder="7501234567890">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre del producto</label>
                        <input type="text" id="modalName" class="form-input" placeholder="Pantal√≥n Slim Fit" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Color</label>
                            <input type="text" id="modalColor" class="form-input" placeholder="Azul marino" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Talla</label>
                            <input type="text" id="modalSize" class="form-input" placeholder="32">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Modelo</label>
                        <input type="text" id="modalModel" class="form-input" placeholder="Slim, Skinny, Regular...">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Precio</label>
                            <input type="number" id="modalPrice" class="form-input" step="0.01" placeholder="599.90">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Stock m√≠nimo</label>
                            <input type="number" id="modalMinStock" class="form-input" value="0" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Stock inicial</label>
                            <input type="number" id="modalStock" class="form-input" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Centro/Almac√©n</label>
                            <input type="text" id="modalCenter" class="form-input" value="General">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Plataforma</label>
                            <input type="text" id="modalPlatform" class="form-input" placeholder="Shein, MercadoLibre...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√∫mero de gu√≠a</label>
                            <input type="text" id="modalTracking" class="form-input" placeholder="Tracking/Gu√≠a">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL de imagen</label>
                        <input type="url" id="modalImage" class="form-input" placeholder="https://...">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        üíæ Guardar producto
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üì§ Carga Masiva CSV (con soporte para acentos)</h3>
                <button class="modal-close" onclick="closeModal('bulkModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="background: var(--bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <p style="font-size: 0.875rem; font-weight: 600;">üìã Formato CSV esperado (soporta acentos y √±):</p>
                    <code style="font-size: 0.75rem; display: block; margin-top: 0.5rem;">
                        barcode,name,color,size,model,unit,center,minStock,price,stock,platform,tracking,image
                    </code>
                    <p style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">
                        ‚úÖ Acepta caracteres especiales: √°, √©, √≠, √≥, √∫, √±, √º, etc.
                    </p>
                    <button class="btn btn-primary" onclick="downloadCSVTemplate()" style="margin-top: 0.75rem;">
                        üìù Descargar plantilla
                    </button>
                </div>
                <div class="form-group">
                    <label class="form-label">Archivo CSV (con soporte para acentos)</label>
                    <input type="file" accept=".csv,text/csv" id="csvFile" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">O pega el CSV aqu√≠ (acepta acentos y caracteres especiales)</label>
                    <textarea id="csvText" class="form-input" rows="10" placeholder="barcode,name,color,size,model...
Ejemplo: 123456,Pantal√≥n Azul,A√±il,32,Cl√°sico..."></textarea>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="processCSV('merge')">
                        ‚úÖ Importar (fusionar)
                    </button>
                    <button class="btn btn-danger" onclick="processCSV('replace')">
                        ‚ö†Ô∏è Reemplazar todo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notifications" class="notifications"></div>

    <script>
        // ==================== ESTADO DE LA APLICACI√ìN ====================
        let state = {
            products: [],
            movements: [],
            operator: '',
            platforms: [],
            adminPassword: '',
            brandLogo: '',
            valuesUnlocked: false,
            currentTab: 'entradas',
            searchQuery: '',
            colorFilter: 'all',
            modelFilter: 'all',
            barcodeFilter: 'all',
            lowStockFilter: false,
            pendingGuide: '',
            editingProduct: null,
            // Mobile scanner
            scannerActive: false,
            // RFID scanning
            rfidActive: false,
            // Cierres mensuales
            monthlyClosed: [],
            // Alertas de stock
            stockAlerts: [],
            // Configuraci√≥n de alertas
            alertsConfig: {
                enabled: true,
                emailNotifications: false,
                alertThreshold: 5
            },
            // M√©tricas
            metrics: {
                dailySales: [],
                topProducts: [],
                lowStockProducts: []
            }
        };

        // ==================== STORAGE KEYS ====================
        const STORAGE_KEYS = {
            products: 'inv_products_premium_v1',
            movements: 'inv_movements_premium_v1',
            operator: 'inv_operator_premium_v1',
            platforms: 'inv_platforms_premium_v1',
            adminPassword: 'inv_admin_password_premium_v1',
            brandLogo: 'inv_brand_logo_premium_v1',
            monthlyClosed: 'inv_monthly_closed_v1',
            stockAlerts: 'inv_stock_alerts_v1',
            alertsConfig: 'inv_alerts_config_v1'
        };

        // ==================== INICIALIZACI√ìN ====================
        function init() {
            // Generar nombre √∫nico para el campo de escaneo para evitar autocompletado
            const uniqueName = 'scan_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('barcodeInput').setAttribute('name', uniqueName);
            
            loadState();
            updateStats();
            updatePlatformSelects();
            // Solo renderizar la secci√≥n activa al inicio
            if (state.currentTab === 'productos') {
                renderProducts();
                updateModelSummary();
            } else if (state.currentTab === 'movimientos') {
                renderMovements();
            }
            setupEventListeners();
            
            // Foco en el campo de escaneo
            document.getElementById('barcodeInput')?.focus();
        }

        // ==================== PERSISTENCIA ====================
        function loadState() {
            try {
                state.products = JSON.parse(localStorage.getItem(STORAGE_KEYS.products) || '[]');
                state.movements = JSON.parse(localStorage.getItem(STORAGE_KEYS.movements) || '[]');
                state.operator = localStorage.getItem(STORAGE_KEYS.operator) || '';
                state.platforms = JSON.parse(localStorage.getItem(STORAGE_KEYS.platforms) || '[]');
                state.adminPassword = localStorage.getItem(STORAGE_KEYS.adminPassword) || '';
                state.brandLogo = localStorage.getItem(STORAGE_KEYS.brandLogo) || '';
                state.monthlyClosed = JSON.parse(localStorage.getItem(STORAGE_KEYS.monthlyClosed) || '[]');
                state.stockAlerts = JSON.parse(localStorage.getItem(STORAGE_KEYS.stockAlerts) || '[]');
                state.alertsConfig = JSON.parse(localStorage.getItem(STORAGE_KEYS.alertsConfig) || '{"enabled":true,"alertThreshold":5}');
                
                console.log('Estado cargado - Movimientos:', state.movements.length);
                console.log('Estado cargado - Productos:', state.products.length);
                console.log('Estado cargado - Cierres mensuales:', state.monthlyClosed.length);
                
                document.getElementById('operatorInput').value = state.operator;
                if (state.brandLogo) {
                    document.getElementById('logoImg').src = state.brandLogo;
                    document.getElementById('logoImg').style.display = 'block';
                    document.getElementById('logoPlaceholder').style.display = 'none';
                }
                
                // Actualizar configuraci√≥n de alertas
                if (document.getElementById('alertsEnabled')) {
                    document.getElementById('alertsEnabled').checked = state.alertsConfig.enabled;
                    document.getElementById('alertThreshold').value = state.alertsConfig.alertThreshold;
                }
            } catch (e) {
                console.error('Error loading state:', e);
            }
        }

        let saveTimeout;
        function saveState() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                try {
                    localStorage.setItem(STORAGE_KEYS.products, JSON.stringify(state.products));
                    localStorage.setItem(STORAGE_KEYS.movements, JSON.stringify(state.movements));
                    localStorage.setItem(STORAGE_KEYS.operator, state.operator);
                    localStorage.setItem(STORAGE_KEYS.platforms, JSON.stringify(state.platforms));
                    localStorage.setItem(STORAGE_KEYS.adminPassword, state.adminPassword);
                    localStorage.setItem(STORAGE_KEYS.brandLogo, state.brandLogo);
                    localStorage.setItem(STORAGE_KEYS.monthlyClosed, JSON.stringify(state.monthlyClosed));
                    localStorage.setItem(STORAGE_KEYS.stockAlerts, JSON.stringify(state.stockAlerts));
                    localStorage.setItem(STORAGE_KEYS.alertsConfig, JSON.stringify(state.alertsConfig));
                    console.log('Estado guardado - Movimientos:', state.movements.length);
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        notify('‚ö†Ô∏è Almacenamiento lleno. Realiza un cierre mensual para liberar espacio.', 'warning');
                    }
                    console.error('Error guardando estado:', e);
                }
            }, 500);
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            document.getElementById('operatorInput').addEventListener('input', (e) => {
                state.operator = e.target.value;
                saveState();
            });

            document.getElementById('searchInput')?.addEventListener('input', (e) => {
                state.searchQuery = e.target.value;
                // Si el usuario est√° buscando, quitar filtro de modelo para evitar confusi√≥n
                if (e.target.value && state.modelFilter !== 'all') {
                    state.modelFilter = 'all';
                    updateModelSummary();
                    const filterStatus = document.getElementById('modelFilterStatus');
                    if (filterStatus) filterStatus.style.display = 'none';
                }
                renderProducts();
            });

            document.getElementById('addTracking').addEventListener('change', (e) => {
                document.getElementById('noGuideGroup').style.display = e.target.checked ? 'flex' : 'none';
            });
            
            // Prevenir autocompletado en el campo de escaneo
            const barcodeInput = document.getElementById('barcodeInput');
            if (barcodeInput) {
                // Limpiar el valor al enfocar para evitar sugerencias
                barcodeInput.addEventListener('focus', (e) => {
                    if (e.target.value === '') {
                        e.target.value = '';
                    }
                });
                
                // Prevenir el men√∫ contextual del navegador
                barcodeInput.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    return false;
                });
            }

            document.getElementById('csvFile')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('csvText').value = e.target.result;
                    };
                    reader.readAsText(file, 'UTF-8'); // Especificar UTF-8 para acentos
                }
            });

            // Cerrar modales con ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.show').forEach(modal => {
                        modal.classList.remove('show');
                    });
                    if (state.scannerActive) {
                        closeMobileScanner();
                    }
                }
            });
        }

        // ==================== MOBILE SCANNER CON QUAGGA ====================
        function openMobileScanner() {
            const modal = document.getElementById('scannerModal');
            modal.classList.add('active');
            state.scannerActive = true;
            
            document.getElementById('scannerStatusText').textContent = 'üîÑ Iniciando c√°mara...';
            document.getElementById('scannerResult').style.display = 'none';
            
            // Configurar QuaggaJS
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-viewport'),
                    constraints: {
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 },
                        facingMode: "environment" // C√°mara trasera en m√≥viles
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: navigator.hardwareConcurrency || 4,
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error(err);
                    document.getElementById('scannerStatusText').textContent = '‚ùå Error al acceder a la c√°mara. Verifica los permisos.';
                    notify('‚ùå No se pudo acceder a la c√°mara', 'error');
                    setTimeout(() => closeMobileScanner(), 2000);
                    return;
                }
                console.log("QuaggaJS iniciado correctamente");
                Quagga.start();
                document.getElementById('scannerStatusText').textContent = 'üîç Apunta la c√°mara al c√≥digo de barras';
            });
            
            // Escuchar cuando se detecta un c√≥digo
            Quagga.onDetected((result) => {
                const code = result.codeResult.code;
                console.log('C√≥digo detectado:', code);
                
                // Vibrar si est√° disponible
                if ('vibrate' in navigator) {
                    navigator.vibrate(200);
                }
                
                // Mostrar el c√≥digo detectado
                document.getElementById('scannerStatusText').textContent = '‚úÖ ¬°C√≥digo detectado!';
                document.getElementById('scannerResultCode').textContent = code;
                document.getElementById('scannerResult').style.display = 'block';
                
                // Detener el scanner
                Quagga.stop();
                
                // Procesar el c√≥digo despu√©s de 1 segundo
                setTimeout(() => {
                    processScanFromMobile(code);
                    closeMobileScanner();
                }, 1000);
            });
            
            // Evento para mejorar la precisi√≥n (opcional)
            Quagga.onProcessed((result) => {
                const drawingCtx = Quagga.canvas.ctx.overlay;
                const drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                        result.boxes.filter(box => box !== result.box).forEach(box => {
                            Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, {
                                color: 'green',
                                lineWidth: 2
                            });
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, {
                            color: '#00F',
                            lineWidth: 2
                        });
                    }

                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, { x: 'x', y: 'y' }, drawingCtx, {
                            color: 'red',
                            lineWidth: 3
                        });
                    }
                }
            });
        }

        function closeMobileScanner() {
            const modal = document.getElementById('scannerModal');
            modal.classList.remove('active');
            state.scannerActive = false;
            
            // Detener QuaggaJS
            if (typeof Quagga !== 'undefined') {
                Quagga.stop();
            }
        }

        function processScanFromMobile(code) {
            // Establecer el c√≥digo en el input
            document.getElementById('barcodeInput').value = code;
            
            // Determinar si es una gu√≠a o un producto
            const addTracking = document.getElementById('addTracking').checked;
            const noGuide = document.getElementById('noGuide').checked;
            const type = document.getElementById('scanType').value;
            
            let product = state.products.find(p => p.barcode === code);
            
            if (addTracking && !noGuide && !product) {
                // Es una gu√≠a
                state.pendingGuide = code;
                document.getElementById('pendingGuideText').textContent = code;
                document.getElementById('pendingGuide').style.display = 'block';
                document.getElementById('barcodeInput').value = '';
                notify(`üì¶ Gu√≠a registrada: ${code}. Ahora escanea el producto.`, 'success');
                return;
            }
            
            // Es un producto, procesar directamente
            const event = new Event('submit');
            event.preventDefault();
            
            // Procesar el escaneo
            processScan(event);
            
            // Notificar al usuario
            const action = type === 'entrada' ? 'agregado al' : 'removido del';
            notify(`‚úÖ Producto ${action} inventario`, 'success');
        }

        // ==================== UTILIDADES ====================
        function generateId() {
            return Math.random().toString(36).substr(2) + Date.now().toString(36);
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount || 0);
        }

        function formatDateTime(timestamp) {
            return new Date(timestamp).toLocaleString('es-MX', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ==================== NOTIFICACIONES ====================
        function notify(message, type = 'info') {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification ${type} animate-in`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <span class="notification-icon">${icons[type]}</span>
                <span class="notification-message">${message}</span>
                <span class="notification-close" onclick="this.parentElement.remove()">√ó</span>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }

        // ==================== GESTI√ìN DE TABS ====================
        function setTab(tab, element) {
            state.currentTab = tab;
            
            // Detener esc√°ner m√≥vil si est√° activo al cambiar de tab
            if (state.scannerActive && (tab !== 'entradas' && tab !== 'salidas')) {
                closeMobileScanner();
            }
            
            // Desactivar RFID si est√° activo
            if (state.rfidActive && (tab !== 'entradas' && tab !== 'salidas')) {
                document.getElementById('useRFID').checked = false;
                toggleRFID();
            }
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            // Si no se pasa element, buscar el bot√≥n por data-tab
            if (!element) {
                element = document.querySelector(`.tab[data-tab="${tab}"]`);
            }
            if (element) element.classList.add('active');
            
            // Show/hide sections
            document.getElementById('scanPanel').style.display = 
                (tab === 'entradas' || tab === 'salidas') ? 'block' : 'none';
            document.getElementById('productsSection').style.display = 
                tab === 'productos' ? 'block' : 'none';
            document.getElementById('movementsSection').style.display = 
                tab === 'movimientos' ? 'block' : 'none';
            document.getElementById('toolsSection').style.display = 
                tab === 'herramientas' ? 'block' : 'none';
            document.getElementById('analyticsSection').style.display = 
                tab === 'analytics' ? 'block' : 'none';
            document.getElementById('modelSummary').style.display = 
                tab === 'productos' ? 'block' : 'none';
            
            // Update scan panel for entradas/salidas
            if (tab === 'entradas' || tab === 'salidas') {
                const isEntrada = tab === 'entradas';
                document.getElementById('scanTitle').textContent = 
                    `${isEntrada ? 'Entradas' : 'Salidas'} ‚Ä¢ Escaneo r√°pido`;
                document.getElementById('scanType').value = isEntrada ? 'entrada' : 'salida';
                document.getElementById('scanIcon').textContent = isEntrada ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è';
                document.getElementById('returnGroup').style.display = isEntrada ? 'flex' : 'none';
                
                const btn = document.querySelector('.scan-panel .btn-success, .scan-panel .btn-danger');
                if (btn) {
                    btn.className = isEntrada ? 'btn btn-success' : 'btn btn-danger';
                }
            }
            
            // Renderizar contenido espec√≠fico de cada tab
                        
            if (tab === 'productos') {
                renderProducts();
                updateModelSummary();
                // Actualizar estado del filtro si hay uno activo
                if (state.modelFilter && state.modelFilter !== 'all') {
                    const filterStatus = document.getElementById('modelFilterStatus');
                    const activeFilter = document.getElementById('activeModelFilter');
                    if (filterStatus && activeFilter) {
                        filterStatus.style.display = 'inline-flex';
                        activeFilter.textContent = state.modelFilter;
                    }
                }
            }
            
            if (tab === 'movimientos') {
                console.log('Cambiando a tab movimientos, renderizando...');
                renderMovements();
            }
            
            if (tab === 'herramientas') {
                renderPlatforms();
                updateLastCloseInfo();
            }
            
            if (tab === 'analytics') {
                // Analytics requiere contrase√±a
                if (!state.valuesUnlocked) {
                    document.getElementById('analyticsLocked').style.display = 'block';
                    document.getElementById('analyticsContent').style.display = 'none';
                } else {
                    document.getElementById('analyticsLocked').style.display = 'none';
                    document.getElementById('analyticsContent').style.display = 'block';
                    updateAnalytics();
                }
            }
        }

        // ==================== ESTAD√çSTICAS ====================
        function updateStats() {
            const totalUnits = state.products.reduce((sum, p) => sum + (p.stock || 0), 0);
            const totalValue = state.products.reduce((sum, p) => sum + ((p.price || 0) * (p.stock || 0)), 0);
            const lowStock = state.products.filter(p => p.stock < (p.minStock || 0)).length;
            
            document.getElementById('statProducts').textContent = state.products.length;
            document.getElementById('statUnits').textContent = 
                state.valuesUnlocked ? totalUnits.toLocaleString() : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            document.getElementById('statValue').textContent = 
                state.valuesUnlocked ? formatMoney(totalValue) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            document.getElementById('statLowStock').textContent = lowStock;
            
            const lowStockIcon = document.getElementById('lowStockIcon');
            if (lowStock > 0) {
                lowStockIcon.style.color = 'var(--warning)';
                // Generar alertas de stock bajo
                checkStockAlerts();
            } else {
                lowStockIcon.style.color = 'inherit';
            }
        }

        function updateModelSummary() {
            const modelStats = new Map();
            
            state.products.forEach(p => {
                const model = p.model || '(Sin modelo)';
                if (!modelStats.has(model)) {
                    modelStats.set(model, { units: 0, skus: 0, lowStock: 0 });
                }
                const stats = modelStats.get(model);
                stats.units += p.stock || 0;
                stats.skus += 1;
                if (p.stock < (p.minStock || 0)) {
                    stats.lowStock += 1;
                }
            });
            
            const container = document.getElementById('modelTags');
            container.innerHTML = '';
            
            modelStats.forEach((stats, model) => {
                const tag = document.createElement('div');
                tag.className = 'model-tag';
                if (state.modelFilter === model) {
                    tag.classList.add('active');
                }
                
                // Agregar indicador de stock bajo si hay productos con stock bajo
                const lowStockBadge = stats.lowStock > 0 ? 
                    `<span style="background: var(--danger); color: white; padding: 0.125rem 0.375rem; border-radius: 999px; font-size: 0.7rem; margin-left: 0.25rem;">‚ö†Ô∏è ${stats.lowStock}</span>` : '';
                
                tag.innerHTML = `<strong>${model}:</strong> ${stats.units} unidades ‚Ä¢ ${stats.skus} SKUs${lowStockBadge}`;
                tag.style.cursor = 'pointer';
                tag.onclick = () => {
                    // Si ya est√° filtrado por este modelo, quitar filtro
                    if (state.modelFilter === model) {
                        setModelFilter('all');
                    } else {
                        setModelFilter(model);
                    }
                };
                
                // Doble clic para mostrar solo productos con stock bajo de este modelo
                tag.ondblclick = () => {
                    state.modelFilter = model;
                    state.lowStockFilter = true;
                    document.getElementById('lowStockFilterBtn').classList.add('active');
                    renderProducts();
                    updateModelSummary();
                    notify(`‚ö†Ô∏è Mostrando productos con stock bajo del modelo: ${model}`, 'warning');
                };
                
                container.appendChild(tag);
            });
        }

        // ==================== TOGGLE VALUES ====================
        function toggleValues() {
            if (!state.valuesUnlocked) {
                if (!state.adminPassword) {
                    notify('‚ö†Ô∏è Primero configura una contrase√±a en Herramientas', 'warning');
                    setTab('herramientas');
                    return;
                }
                const password = prompt('üîê Contrase√±a para ver valores y unidades:');
                if (password === state.adminPassword) {
                    state.valuesUnlocked = true;
                    notify('‚úÖ Valores y unidades desbloqueados', 'success');
                } else if (password !== null) {
                    notify('‚ùå Contrase√±a incorrecta', 'error');
                    return;
                }
            } else {
                state.valuesUnlocked = false;
                notify('üîí Valores y unidades ocultos', 'info');
            }
            
            document.getElementById('valuesIcon').textContent = state.valuesUnlocked ? 'üîí' : 'üëÅÔ∏è';
            document.getElementById('valuesText').textContent = state.valuesUnlocked ? 'Ocultar datos' : 'Ver datos';
            updateStats();
            renderProducts();
        }

        // ==================== RFID SCANNING ====================
        function toggleRFID() {
            const useRFID = document.getElementById('useRFID').checked;
            const rfidSection = document.getElementById('rfidSection');
            const barcodeInput = document.getElementById('barcodeInput');
            
            if (useRFID) {
                state.rfidActive = true;
                rfidSection.style.display = 'block';
                
                // Configurar el campo para RFID
                barcodeInput.placeholder = "Esperando lectura RFID... Acerca la etiqueta al lector";
                barcodeInput.style.background = '#e0e7ff';
                barcodeInput.focus();
                
                // Notificar al usuario
                notify('üì° Modo RFID activado. Acerca la etiqueta al lector.', 'info');
                
                // Listener especial para RFID (detecta entrada r√°pida)
                setupRFIDListener();
            } else {
                state.rfidActive = false;
                rfidSection.style.display = 'none';
                barcodeInput.placeholder = "Escanea o escribe...";
                barcodeInput.style.background = '';
                removeRFIDListener();
            }
        }
        
        let rfidTimeout = null;
        let rfidBuffer = '';
        
        function setupRFIDListener() {
            const input = document.getElementById('barcodeInput');
            
            // Detectar entrada r√°pida t√≠pica de lectores RFID
            input.addEventListener('input', handleRFIDInput);
            input.addEventListener('keypress', handleRFIDKeypress);
        }
        
        function removeRFIDListener() {
            const input = document.getElementById('barcodeInput');
            input.removeEventListener('input', handleRFIDInput);
            input.removeEventListener('keypress', handleRFIDKeypress);
            clearTimeout(rfidTimeout);
            rfidBuffer = '';
        }
        
        function handleRFIDInput(e) {
            // Los lectores RFID t√≠picamente escriben muy r√°pido
            clearTimeout(rfidTimeout);
            
            rfidTimeout = setTimeout(() => {
                // Si hay contenido despu√©s de entrada r√°pida, probablemente es RFID
                if (e.target.value.length > 5) {
                    console.log('RFID detectado:', e.target.value);
                    // Auto-procesar si est√° habilitado
                    if (document.getElementById('autoPlus').checked) {
                        const event = new Event('submit');
                        event.preventDefault();
                        setTimeout(() => processScan(event), 100);
                    }
                }
            }, 100); // Los lectores RFID escriben en menos de 100ms
        }
        
        function handleRFIDKeypress(e) {
            // Muchos lectores RFID env√≠an Enter al final
            if (e.key === 'Enter' && e.target.value) {
                console.log('RFID con Enter detectado:', e.target.value);
                // Vibraci√≥n si est√° disponible
                if ('vibrate' in navigator) {
                    navigator.vibrate(100);
                }
            }
        }

        // ==================== ESCANEO ====================
        function processScan(event) {
            if (event) event.preventDefault();
            
            const barcode = document.getElementById('barcodeInput').value.trim();
            if (!barcode) return;
            
            const type = document.getElementById('scanType').value;
            const qty = document.getElementById('autoPlus').checked ? 1 : 
                       parseInt(document.getElementById('scanQty').value) || 1;
            const addTracking = document.getElementById('addTracking').checked;
            const noGuide = document.getElementById('noGuide').checked;
            
            let product = state.products.find(p => p.barcode === barcode);
            
            if (addTracking && !noGuide) {
                if (!product) {
                    // Es una gu√≠a
                    state.pendingGuide = barcode;
                    document.getElementById('pendingGuideText').textContent = barcode;
                    document.getElementById('pendingGuide').style.display = 'block';
                    document.getElementById('barcodeInput').value = '';
                    document.getElementById('barcodeInput').focus();
                    return;
                }
            }
            
            // Si no existe el producto, cr√©alo
            if (!product) {
                product = {
                    id: generateId(),
                    barcode: barcode,
                    name: 'Producto nuevo',
                    color: 'Sin definir',
                    stock: 0,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                state.products.push(product);
            }
            
            // Crear movimiento
            const movement = {
                id: generateId(),
                productId: product.id,
                barcode: product.barcode,
                type: type,
                qty: qty,
                when: Date.now(),
                operator: state.operator,
                platform: document.getElementById('platformSelect').value,
                tracking: state.pendingGuide || '',
                isReturn: document.getElementById('isReturn').checked
            };
            
            // Actualizar stock
            if (type === 'entrada') {
                product.stock = (product.stock || 0) + qty;
            } else {
                product.stock = Math.max(0, (product.stock || 0) - qty);
            }
            product.updatedAt = Date.now();
            
            // Agregar movimiento al principio del array
            state.movements.unshift(movement);
            console.log('Movimiento creado:', movement);
            console.log('Total movimientos:', state.movements.length);
            
            // Limitar movimientos guardados
            if (state.movements.length > 10000) {
                state.movements = state.movements.slice(0, 10000);
            }
            
            // Notificar y limpiar
            const action = type === 'entrada' ? '‚ûï' : '‚ûñ';
            notify(`${action} ${qty} ${product.name} (Stock: ${product.stock})`, 'success');
            
            // Sonido de confirmaci√≥n
            playBeep();
            
            // Limpiar campos
            document.getElementById('barcodeInput').value = '';
            // Cambiar el nombre del campo para evitar autocompletado
            const newName = 'scan_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('barcodeInput').setAttribute('name', newName);
            document.getElementById('barcodeInput').focus();
            document.getElementById('pendingGuide').style.display = 'none';
            document.getElementById('noGuide').checked = false;
            state.pendingGuide = '';
            
            // Actualizar UI
            saveState();
            updateStats();
            if (state.currentTab === 'productos') {
                renderProducts();
                updateModelSummary();
            }
            if (state.currentTab === 'movimientos') {
                renderMovements();
            }
        }

        function playBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 880;
                gainNode.gain.value = 0.05;
                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                    audioContext.close();
                }, 120);
            } catch (e) {}
        }

        // ==================== RENDER PRODUCTOS ====================
        function renderProducts() {
            const tbody = document.getElementById('productsTable');
            if (!tbody) return;
            
            // Asegurar que el bot√≥n "Todos modelos" est√© activo si no hay filtro
            if (state.modelFilter === 'all') {
                const btn = document.getElementById('modelFilterAll');
                if (btn) btn.classList.add('active');
            }
            
            // Filtrar productos
            let filtered = state.products;
            
            if (state.searchQuery) {
                const q = state.searchQuery.toLowerCase();
                filtered = filtered.filter(p => 
                    p.name?.toLowerCase().includes(q) ||
                    p.barcode?.toLowerCase().includes(q) ||
                    p.model?.toLowerCase().includes(q) ||
                    p.color?.toLowerCase().includes(q)
                );
            }
            
            if (state.colorFilter !== 'all') {
                filtered = filtered.filter(p => p.color === state.colorFilter);
            }
            
            if (state.modelFilter !== 'all') {
                filtered = filtered.filter(p => p.model === state.modelFilter);
            }
            
            if (state.barcodeFilter === 'nocode') {
                filtered = filtered.filter(p => !p.barcode);
            }
            
            if (state.lowStockFilter) {
                filtered = filtered.filter(p => p.stock < (p.minStock || 0));
            }
            
            // Ordenar por modelo y nombre
            const modelOrder = ['Slim', 'Skinny', 'Regular', 'Bootcut', 'Straight', 'Relaxed'];
            filtered.sort((a, b) => {
                const aIdx = modelOrder.indexOf(a.model) === -1 ? 999 : modelOrder.indexOf(a.model);
                const bIdx = modelOrder.indexOf(b.model) === -1 ? 999 : modelOrder.indexOf(b.model);
                if (aIdx !== bIdx) return aIdx - bIdx;
                return (a.name || '').localeCompare(b.name || '');
            });
            
            // Agrupar por modelo
            const grouped = {};
            filtered.forEach(p => {
                const model = p.model || '(Sin modelo)';
                if (!grouped[model]) grouped[model] = [];
                grouped[model].push(p);
            });
            
            // Renderizar
            tbody.innerHTML = '';
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <div class="empty-state-title">No hay productos</div>
                            <div>Agrega productos o ajusta los filtros</div>
                        </td>
                    </tr>
                `;
                document.getElementById('productsCount').textContent = '(0 total)';
                return;
            }
            
            Object.keys(grouped).forEach(model => {
                // Header del modelo
                const modelRow = tbody.insertRow();
                modelRow.className = 'model-header';
                modelRow.innerHTML = `<td colspan="12" style="font-weight: 700;">üìç ${model}</td>`;
                
                // Productos del modelo
                grouped[model].forEach(product => {
                    const row = tbody.insertRow();
                    
                    const stockClass = product.stock === 0 ? 'stock-zero' : 
                                      product.stock < (product.minStock || 0) ? 'stock-low' : 
                                      'stock-ok';
                    
                    row.innerHTML = `
                        <td>
                            ${product.image ? 
                                `<img src="${product.image}" class="product-image">` :
                                `<div class="product-image-placeholder">üñºÔ∏è</div>`
                            }
                        </td>
                        <td>${product.model || '‚Äì'}</td>
                        <td style="font-family: monospace; color: var(--text-light);">
                            ${product.barcode || '‚Äî'}
                        </td>
                        <td><strong>${product.name}</strong></td>
                        <td>${product.color}</td>
                        <td>${product.size || '‚Äì'}</td>
                        <td>${state.valuesUnlocked ? formatMoney(product.price) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</td>
                        <td style="text-align: center;">${product.minStock || 0}</td>
                        <td>
                            <span class="stock-badge ${stockClass}">${product.stock}</span>
                        </td>
                        <td>${product.platform || '‚Äì'}</td>
                        <td style="font-size: 0.75rem;">${product.tracking || '‚Äì'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn plus" onclick="quickStock('${product.id}', 'entrada')">
                                    +1
                                </button>
                                <button class="action-btn minus" onclick="quickStock('${product.id}', 'salida')">
                                    -1
                                </button>
                                <button class="action-btn" onclick="editProduct('${product.id}')">
                                    ‚úèÔ∏è
                                </button>
                                <button class="action-btn" onclick="deleteProduct('${product.id}')" style="color: var(--danger);">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    `;
                });
            });
            
            // Actualizar contador y filtros
            document.getElementById('productsCount').textContent = `(${filtered.length} total)`;
            updateColorFilters();
            updateModelFilters();
        }

        // ==================== FILTROS ====================
        function updateColorFilters() {
            const colors = [...new Set(state.products.map(p => p.color).filter(Boolean))].sort();
            const container = document.getElementById('colorFilters');
            if (!container) return;
            
            container.innerHTML = '';
            colors.slice(0, 3).forEach(color => {
                const btn = document.createElement('button');
                btn.className = state.colorFilter === color ? 'filter-btn active' : 'filter-btn';
                btn.innerHTML = `<span>üé®</span> ${color}`;
                btn.onclick = () => setColorFilter(color);
                container.appendChild(btn);
            });
        }

        function updateModelFilters() {
            const models = [...new Set(state.products.map(p => p.model).filter(Boolean))].sort();
            const container = document.getElementById('modelFilters');
            if (!container) return;
            
            container.innerHTML = '';
            models.slice(0, 3).forEach(model => {
                const btn = document.createElement('button');
                btn.className = state.modelFilter === model ? 'filter-btn active' : 'filter-btn';
                btn.innerHTML = `<span>üëî</span> ${model}`;
                btn.onclick = () => {
                    // Si ya est√° filtrado por este modelo, quitar filtro
                    if (state.modelFilter === model) {
                        setModelFilter('all');
                    } else {
                        setModelFilter(model);
                    }
                };
                container.appendChild(btn);
            });
        }

        function setColorFilter(color) {
            state.colorFilter = color;
            document.querySelectorAll('#colorFilters .filter-btn, .filter-btn[onclick*="setColorFilter"]').forEach(btn => {
                btn.classList.remove('active');
            });
            if (color === 'all') {
                document.querySelector('.filter-btn[onclick*="setColorFilter(\'all\')"]').classList.add('active');
            }
            renderProducts();
        }

        function setModelFilter(model) {
            state.modelFilter = model;
            
            // Actualizar botones de filtro en la barra de filtros
            document.querySelectorAll('#modelFilters .filter-btn, .filter-btn[onclick*="setModelFilter"]').forEach(btn => {
                btn.classList.remove('active');
            });
            if (model === 'all') {
                const allBtn = document.getElementById('modelFilterAll');
                if (allBtn) allBtn.classList.add('active');
                // Ocultar estado de filtro
                const filterStatus = document.getElementById('modelFilterStatus');
                if (filterStatus) filterStatus.style.display = 'none';
            } else {
                // Buscar y activar el bot√≥n correspondiente si existe
                document.querySelectorAll('#modelFilters .filter-btn').forEach(btn => {
                    if (btn.textContent.includes(model)) {
                        btn.classList.add('active');
                    }
                });
                // Mostrar estado de filtro activo
                const filterStatus = document.getElementById('modelFilterStatus');
                const activeFilter = document.getElementById('activeModelFilter');
                if (filterStatus && activeFilter) {
                    filterStatus.style.display = 'inline-flex';
                    activeFilter.textContent = model;
                }
                
                // Hacer scroll suave a la tabla de productos
                setTimeout(() => {
                    document.getElementById('productsSection').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            }
            
            // Actualizar el resumen de modelos para mostrar cu√°l est√° activo
            updateModelSummary();
            
            // Renderizar productos filtrados
            renderProducts();
            
            // Notificar al usuario
            if (model !== 'all') {
                notify(`üè∑Ô∏è Filtrando por modelo: ${model}`, 'info');
            }
        }

        function setBarcodeFilter() {
            state.barcodeFilter = state.barcodeFilter === 'nocode' ? 'all' : 'nocode';
            const btn = document.getElementById('barcodeFilterBtn');
            if (state.barcodeFilter === 'nocode') {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            renderProducts();
        }

        function setLowStockFilter() {
            state.lowStockFilter = !state.lowStockFilter;
            const btn = document.getElementById('lowStockFilterBtn');
            if (state.lowStockFilter) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            renderProducts();
        }

        function clearAllFilters() {
            // Limpiar todos los filtros
            state.searchQuery = '';
            state.colorFilter = 'all';
            state.modelFilter = 'all';
            state.barcodeFilter = 'all';
            state.lowStockFilter = false;
            
            // Limpiar campo de b√∫squeda
            document.getElementById('searchInput').value = '';
            
            // Resetear botones
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.filter-btn[onclick*="setColorFilter(\'all\')"]').classList.add('active');
            document.getElementById('modelFilterAll').classList.add('active');
            
            // Ocultar estado de filtro
            const filterStatus = document.getElementById('modelFilterStatus');
            if (filterStatus) filterStatus.style.display = 'none';
            
            // Actualizar vista
            renderProducts();
            updateModelSummary();
            
            notify('üîÑ Todos los filtros limpiados', 'info');
        }

        function showLowStock() {
            state.lowStockFilter = true;
            setTab('productos');
            document.getElementById('lowStockFilterBtn').classList.add('active');
            renderProducts();
            updateModelSummary(); // Actualizar resumen tambi√©n
        }

        // ==================== ACCIONES R√ÅPIDAS ====================
        function quickStock(productId, type) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            const movement = {
                id: generateId(),
                productId: product.id,
                barcode: product.barcode,
                type: type,
                qty: 1,
                when: Date.now(),
                operator: state.operator || '',
                platform: '',
                tracking: '',
                isReturn: false
            };
            
            if (type === 'entrada') {
                product.stock = (product.stock || 0) + 1;
            } else {
                product.stock = Math.max(0, (product.stock || 0) - 1);
            }
            product.updatedAt = Date.now();
            
            // Agregar movimiento al principio del array
            state.movements.unshift(movement);
            console.log('Movimiento r√°pido creado:', movement);
            
            const action = type === 'entrada' ? '‚ûï' : '‚ûñ';
            notify(`${action}1 ${product.name} (Stock: ${product.stock})`, 'success');
            
            saveState();
            updateStats();
            renderProducts();
            updateModelSummary();
            if (state.currentTab === 'movimientos') {
                renderMovements();
            }
        }

        // ==================== CRUD PRODUCTOS ====================
        function openAddModal() {
            state.editingProduct = null;
            document.getElementById('productForm').reset();
            document.getElementById('modalStock').value = '0';
            document.getElementById('modalMinStock').value = '0';
            document.getElementById('modalCenter').value = 'General';
            document.getElementById('addModal').classList.add('show');
            setTimeout(() => document.getElementById('modalBarcode').focus(), 100);
        }

        function editProduct(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            state.editingProduct = product;
            
            document.getElementById('modalBarcode').value = product.barcode || '';
            document.getElementById('modalName').value = product.name || '';
            document.getElementById('modalColor').value = product.color || '';
            document.getElementById('modalSize').value = product.size || '';
            document.getElementById('modalModel').value = product.model || '';
            document.getElementById('modalPrice').value = product.price || '';
            document.getElementById('modalStock').value = product.stock || 0;
            document.getElementById('modalMinStock').value = product.minStock || 0;
            document.getElementById('modalCenter').value = product.center || 'General';
            document.getElementById('modalPlatform').value = product.platform || '';
            document.getElementById('modalTracking').value = product.tracking || '';
            document.getElementById('modalImage').value = product.image || '';
            
            document.getElementById('addModal').classList.add('show');
        }

        function saveProduct(event) {
            event.preventDefault();
            
            const productData = {
                barcode: document.getElementById('modalBarcode').value.trim(),
                name: document.getElementById('modalName').value.trim() || 'Pantal√≥n',
                color: document.getElementById('modalColor').value.trim() || 'Sin color',
                size: document.getElementById('modalSize').value.trim(),
                model: document.getElementById('modalModel').value.trim(),
                price: parseFloat(document.getElementById('modalPrice').value) || 0,
                stock: parseInt(document.getElementById('modalStock').value) || 0,
                minStock: parseInt(document.getElementById('modalMinStock').value) || 0,
                center: document.getElementById('modalCenter').value.trim() || 'General',
                platform: document.getElementById('modalPlatform').value.trim(),
                tracking: document.getElementById('modalTracking').value.trim(),
                image: document.getElementById('modalImage').value.trim()
            };
            
            if (state.editingProduct) {
                // Actualizar existente
                Object.assign(state.editingProduct, productData, {
                    updatedAt: Date.now()
                });
                notify(`‚úÖ Producto actualizado: ${productData.name}`, 'success');
            } else {
                // Crear nuevo
                const newProduct = {
                    id: generateId(),
                    ...productData,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                state.products.push(newProduct);
                notify(`‚úÖ Producto creado: ${productData.name}`, 'success');
            }
            
            saveState();
            updateStats();
            renderProducts();
            updateModelSummary();
            closeModal('addModal');
        }

        function deleteProduct(productId) {
            if (!confirm('¬øEliminar este producto? Esta acci√≥n no se puede deshacer.')) return;
            
            state.products = state.products.filter(p => p.id !== productId);
            notify('üóëÔ∏è Producto eliminado', 'info');
            
            saveState();
            updateStats();
            renderProducts();
            updateModelSummary();
        }

        // ==================== MOVIMIENTOS ====================
        function renderMovements() {
            const tbody = document.getElementById('movementsTable');
            if (!tbody) return;
            
            // Mostrar los √∫ltimos 100 movimientos
            const recentMovements = state.movements.slice(0, 100);
            
            tbody.innerHTML = '';
            
            if (recentMovements.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <div class="empty-state-title">No hay movimientos</div>
                            <div>Los movimientos aparecer√°n aqu√≠ cuando registres entradas o salidas</div>
                        </td>
                    </tr>
                `;
                document.getElementById('movementsCount').textContent = '(0 total)';
                return;
            }
            
            recentMovements.forEach(movement => {
                const product = state.products.find(p => p.id === movement.productId);
                const row = tbody.insertRow();
                
                const typeClass = movement.type === 'entrada' ? 'stock-ok' : 'stock-zero';
                const typeIcon = movement.type === 'entrada' ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è';
                
                row.innerHTML = `
                    <td>${formatDateTime(movement.when)}</td>
                    <td style="font-family: monospace; color: var(--text-light);">${movement.barcode || '‚Äî'}</td>
                    <td><strong>${product?.name || '(producto eliminado)'}</strong></td>
                    <td>${product?.size || '‚Äì'}</td>
                    <td>${product?.color || '‚Äì'}</td>
                    <td>${product?.model || '‚Äì'}</td>
                    <td>
                        <span class="stock-badge ${typeClass}">
                            ${typeIcon} ${movement.type}
                        </span>
                    </td>
                    <td style="text-align: right; font-weight: 600;">${movement.qty}</td>
                    <td>${movement.operator || '‚Äì'}</td>
                    <td>${movement.platform || '‚Äì'}</td>
                    <td style="font-size: 0.75rem;">${movement.tracking || '‚Äì'}</td>
                    <td>${movement.isReturn ? '‚úÖ S√≠' : '‚Äì'}</td>
                `;
            });
            
            document.getElementById('movementsCount').textContent = `(${state.movements.length} total)`;
            console.log('Movimientos renderizados:', recentMovements.length);
        }

        // ==================== HERRAMIENTAS ====================
        function updatePlatformSelects() {
            const select = document.getElementById('platformSelect');
            if (select) {
                const current = select.value;
                select.innerHTML = '<option value="">(Sin plataforma)</option>';
                state.platforms.forEach(platform => {
                    select.innerHTML += `<option value="${platform}">${platform}</option>`;
                });
                select.value = current;
            }
        }

        function renderPlatforms() {
            const container = document.getElementById('platformsList');
            if (!container) return;
            
            container.innerHTML = '';
            state.platforms.forEach(platform => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;';
                div.innerHTML = `
                    <span style="flex: 1; padding: 0.5rem; background: var(--bg); border-radius: var(--radius);">
                        üì± ${platform}
                    </span>
                    <button class="btn btn-outline-danger" onclick="removePlatform('${platform}')">
                        Eliminar
                    </button>
                `;
                container.appendChild(div);
            });
            
            if (state.platforms.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); font-size: 0.875rem;">No hay plataformas configuradas</p>';
            }
        }

        function addPlatform() {
            const input = document.getElementById('newPlatform');
            const name = input.value.trim();
            
            if (!name) return;
            if (state.platforms.includes(name)) {
                notify('‚ö†Ô∏è Esa plataforma ya existe', 'warning');
                return;
            }
            
            state.platforms.push(name);
            input.value = '';
            
            notify(`‚úÖ Plataforma "${name}" agregada`, 'success');
            saveState();
            updatePlatformSelects();
            renderPlatforms();
        }

        function removePlatform(name) {
            if (!confirm(`¬øEliminar la plataforma "${name}"?`)) return;
            
            state.platforms = state.platforms.filter(p => p !== name);
            notify(`üóëÔ∏è Plataforma "${name}" eliminada`, 'info');
            
            saveState();
            updatePlatformSelects();
            renderPlatforms();
        }

        function savePassword() {
            const password = document.getElementById('adminPassword').value.trim();
            if (!password) {
                notify('‚ö†Ô∏è Ingresa una contrase√±a v√°lida', 'warning');
                return;
            }
            state.adminPassword = password;
            saveState();
            notify('‚úÖ Contrase√±a guardada correctamente', 'success');
        }

        // ==================== EXPORTACI√ìN/IMPORTACI√ìN ====================
        function clearAll() {
            if (!state.adminPassword) {
                notify('‚ö†Ô∏è Primero configura una contrase√±a en Herramientas', 'warning');
                setTab('herramientas');
                return;
            }
            
            const password = prompt('üîê Escribe la contrase√±a de administraci√≥n:');
            if (password !== state.adminPassword) {
                if (password !== null) notify('‚ùå Contrase√±a incorrecta', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ¬øVaciar TODO el inventario y movimientos? Esta acci√≥n no se puede deshacer.')) return;
            
            state.products = [];
            state.movements = [];
            saveState();
            updateStats();
            renderProducts();
            renderMovements();
            updateModelSummary();
            notify('‚úÖ Inventario vaciado completamente', 'success');
        }

        function exportProductsCSV() {
            const headers = ['barcode', 'name', 'color', 'size', 'model', 'unit', 'center', 'minStock', 'price', 'stock', 'platform', 'tracking', 'image', 'updatedAt'];
            const rows = [headers];
            
            state.products.forEach(p => {
                rows.push([
                    p.barcode || '',
                    p.name || '',
                    p.color || '',
                    p.size || '',
                    p.model || '',
                    p.unit || 'Unidad',
                    p.center || 'General',
                    p.minStock || 0,
                    p.price || '',
                    p.stock || 0,
                    p.platform || '',
                    p.tracking || '',
                    p.image || '',
                    new Date(p.updatedAt || Date.now()).toISOString()
                ]);
            });
            
            const csv = rows.map(row => 
                row.map(cell => {
                    const str = String(cell);
                    return str.includes(',') || str.includes('"') || str.includes('\n') ? 
                           `"${str.replace(/"/g, '""')}"` : str;
                }).join(',')
            ).join('\n');
            
            // Agregar BOM para UTF-8 para que Excel reconozca los acentos
            const BOM = '\uFEFF';
            downloadFile(BOM + csv, `productos-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8');
            notify('‚úÖ CSV de productos descargado', 'success');
        }

        function exportMovementsCSV() {
            const headers = ['when', 'barcode', 'product', 'size', 'color', 'model', 'type', 'qty', 'operator', 'platform', 'tracking', 'isReturn'];
            const rows = [headers];
            
            state.movements.forEach(m => {
                const product = state.products.find(p => p.id === m.productId);
                rows.push([
                    new Date(m.when).toISOString(),
                    m.barcode || '',
                    product?.name || '(eliminado)',
                    product?.size || '',
                    product?.color || '',
                    product?.model || '',
                    m.type,
                    m.qty,
                    m.operator || '',
                    m.platform || '',
                    m.tracking || '',
                    m.isReturn ? 'S√≠' : 'No'
                ]);
            });
            
            const csv = rows.map(row => 
                row.map(cell => {
                    const str = String(cell);
                    return str.includes(',') || str.includes('"') || str.includes('\n') ? 
                           `"${str.replace(/"/g, '""')}"` : str;
                }).join(',')
            ).join('\n');
            
            // Agregar BOM para UTF-8 para que Excel reconozca los acentos
            const BOM = '\uFEFF';
            downloadFile(BOM + csv, `movimientos-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8');
            notify('‚úÖ CSV de movimientos descargado', 'success');
        }

        function exportJSON() {
            const data = {
                products: state.products,
                movements: state.movements,
                operator: state.operator,
                platforms: state.platforms,
                exportedAt: new Date().toISOString(),
                version: '1.0.0'
            };
            
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, `inventario-john-silver-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            notify('‚úÖ Respaldo JSON descargado', 'success');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type || 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadCSVTemplate() {
            const headers = 'barcode,name,color,size,model,unit,center,minStock,price,stock,platform,tracking,image';
            const rows = [headers];
            // Ejemplos con acentos
            rows.push('123456,Pantal√≥n Cl√°sico,Azul A√±il,32,Cl√°sico,Unidad,General,5,599.90,10,,,');
            rows.push('789012,Camisa B√°sica,Caf√©,M,B√°sico,Unidad,General,3,399.90,15,,,');
            rows.push(',Chamarra de Algod√≥n,Negro,L,,Unidad,General,2,899.90,5,,,');
            for (let i = 0; i < 2; i++) {
                rows.push(',,,,,Unidad,General,0,,0,,,');
            }
            const BOM = '\uFEFF';
            downloadFile(BOM + rows.join('\n'), 'plantilla-productos.csv', 'text/csv;charset=utf-8');
            notify('‚úÖ Plantilla CSV descargada', 'success');
        }

        // ==================== CARGA MASIVA ====================
        function openBulkModal() {
            document.getElementById('bulkModal').classList.add('show');
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote mode
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add last field
            result.push(current.trim());
            
            return result;
        }

        function processCSV(mode) {
            const text = document.getElementById('csvText').value;
            if (!text) {
                notify('‚ö†Ô∏è Por favor carga o pega un archivo CSV', 'warning');
                return;
            }
            
            try {
                const lines = text.split(/\r?\n/).filter(l => l.trim());
                const headers = parseCSVLine(lines[0]);
                const products = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    
                    // Solo procesar si hay valores
                    if (values.some(v => v)) {
                        const product = {
                            id: generateId(),
                            barcode: values[headers.indexOf('barcode')] || '',
                            name: values[headers.indexOf('name')] || 'Pantal√≥n',
                            color: values[headers.indexOf('color')] || 'Sin color',
                            size: values[headers.indexOf('size')] || '',
                            model: values[headers.indexOf('model')] || '',
                            price: parseFloat(values[headers.indexOf('price')]) || 0,
                            stock: parseInt(values[headers.indexOf('stock')]) || 0,
                            unit: values[headers.indexOf('unit')] || 'Unidad',
                            center: values[headers.indexOf('center')] || 'General',
                            minStock: parseInt(values[headers.indexOf('minStock')]) || 0,
                            platform: values[headers.indexOf('platform')] || '',
                            tracking: values[headers.indexOf('tracking')] || '',
                            image: values[headers.indexOf('image')] || '',
                            createdAt: Date.now(),
                            updatedAt: Date.now()
                        };
                        products.push(product);
                    }
                }
                
                if (mode === 'replace') {
                    if (!state.adminPassword) {
                        notify('‚ö†Ô∏è Configura una contrase√±a primero', 'warning');
                        setTab('herramientas');
                        return;
                    }
                    const password = prompt('üîê Contrase√±a de administraci√≥n:');
                    if (password !== state.adminPassword) {
                        notify('‚ùå Contrase√±a incorrecta', 'error');
                        return;
                    }
                    if (!confirm('‚ö†Ô∏è ¬øReemplazar TODO el inventario?')) return;
                    
                    state.products = products;
                    notify(`‚úÖ Inventario reemplazado: ${products.length} productos`, 'success');
                } else {
                    // Merge
                    products.forEach(newProduct => {
                        if (newProduct.barcode) {
                            const existing = state.products.find(p => p.barcode === newProduct.barcode);
                            if (existing) {
                                Object.assign(existing, newProduct);
                            } else {
                                state.products.push(newProduct);
                            }
                        } else {
                            state.products.push(newProduct);
                        }
                    });
                    notify(`‚úÖ Importados/actualizados ${products.length} productos`, 'success');
                }
                
                saveState();
                updateStats();
                renderProducts();
                updateModelSummary();
                closeModal('bulkModal');
            } catch (error) {
                notify('‚ùå Error procesando CSV: ' + error.message, 'error');
                console.error('Error detallado:', error);
            }
        }

        // ==================== MODALES ====================
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // ==================== LOGO ====================
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tama√±o
            if (file.size > 150000) {
                notify('‚ö†Ô∏è La imagen es muy grande. Usa una imagen menor a 150KB', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                state.brandLogo = e.target.result;
                document.getElementById('logoImg').src = state.brandLogo;
                document.getElementById('logoImg').style.display = 'block';
                document.getElementById('logoPlaceholder').style.display = 'none';
                saveState();
                notify('‚úÖ Logo actualizado', 'success');
            };
            reader.readAsDataURL(file);
        }

        // ==================== ANALYTICS ====================
        function unlockAnalytics() {
            if (!state.adminPassword) {
                notify('‚ö†Ô∏è Primero configura una contrase√±a en Herramientas', 'warning');
                setTab('herramientas');
                return;
            }
            
            const password = prompt('üîê Contrase√±a para acceder a Analytics:');
            if (password === state.adminPassword) {
                state.valuesUnlocked = true;
                document.getElementById('analyticsLocked').style.display = 'none';
                document.getElementById('analyticsContent').style.display = 'block';
                updateAnalytics();
                notify('‚úÖ Analytics desbloqueado', 'success');
            } else if (password !== null) {
                notify('‚ùå Contrase√±a incorrecta', 'error');
            }
        }

        function lockAnalytics() {
            state.valuesUnlocked = false;
            document.getElementById('analyticsLocked').style.display = 'block';
            document.getElementById('analyticsContent').style.display = 'none';
            updateStats();
            renderProducts();
            notify('üîí Analytics bloqueado', 'info');
        }

        function updateAnalytics() {
            // Calcular m√©tricas del mes actual
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthMovements = state.movements.filter(m => m.when >= startOfMonth.getTime());
            
            // Ventas del mes
            const monthSales = monthMovements.filter(m => m.type === 'salida').reduce((sum, m) => sum + m.qty, 0);
            document.getElementById('monthSales').textContent = monthSales.toLocaleString();
            
            // Valor vendido (aproximado)
            let monthRevenue = 0;
            monthMovements.filter(m => m.type === 'salida').forEach(m => {
                const product = state.products.find(p => p.id === m.productId);
                if (product && product.price) {
                    monthRevenue += product.price * m.qty;
                }
            });
            document.getElementById('monthRevenue').textContent = formatMoney(monthRevenue);
            
            // Rotaci√≥n promedio
            const totalStock = state.products.reduce((sum, p) => sum + (p.stock || 0), 0);
            const rotation = totalStock > 0 ? Math.round((monthSales / totalStock) * 100) : 0;
            document.getElementById('avgRotation').textContent = rotation + '%';
            
            // Producto estrella
            const productSales = {};
            monthMovements.filter(m => m.type === 'salida').forEach(m => {
                const product = state.products.find(p => p.id === m.productId);
                if (product) {
                    if (!productSales[product.name]) productSales[product.name] = 0;
                    productSales[product.name] += m.qty;
                }
            });
            const topProduct = Object.entries(productSales).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('topProduct').textContent = topProduct ? `${topProduct[0]} (${topProduct[1]} u.)` : 'Sin ventas';
            
            // Actualizar gr√°ficas
            updateCharts();
            
            // Actualizar alertas
            updateStockAlerts();
        }

        let charts = {};

        function updateCharts() {
            // Limpiar gr√°ficas anteriores
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            // Gr√°fica de movimientos diarios
            const ctx1 = document.getElementById('dailyMovementsChart').getContext('2d');
            const last30Days = [];
            const entriesData = [];
            const exitsData = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
                const dayEnd = dayStart + 86400000;
                
                const dayMovements = state.movements.filter(m => m.when >= dayStart && m.when < dayEnd);
                const entries = dayMovements.filter(m => m.type === 'entrada').reduce((sum, m) => sum + m.qty, 0);
                const exits = dayMovements.filter(m => m.type === 'salida').reduce((sum, m) => sum + m.qty, 0);
                
                last30Days.push(date.getDate() + '/' + (date.getMonth() + 1));
                entriesData.push(entries);
                exitsData.push(exits);
            }
            
            charts.daily = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: last30Days,
                    datasets: [{
                        label: 'Entradas',
                        data: entriesData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.3
                    }, {
                        label: 'Salidas',
                        data: exitsData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
            
            // Gr√°fica de productos m√°s vendidos
            const ctx2 = document.getElementById('topProductsChart').getContext('2d');
            const productSales = {};
            state.movements.filter(m => m.type === 'salida').forEach(m => {
                const product = state.products.find(p => p.id === m.productId);
                if (product) {
                    if (!productSales[product.name]) productSales[product.name] = 0;
                    productSales[product.name] += m.qty;
                }
            });
            
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            charts.topProducts = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: topProducts.map(p => p[0].substring(0, 20)),
                    datasets: [{
                        label: 'Unidades vendidas',
                        data: topProducts.map(p => p[1]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            // Gr√°fica de tendencia de inventario
            const ctx3 = document.getElementById('inventoryTrendChart').getContext('2d');
            const inventoryData = [];
            const dates = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i * 5);
                const dayMovements = state.movements.filter(m => m.when <= date.getTime());
                
                let totalStock = 0;
                state.products.forEach(p => {
                    let stock = p.stock || 0;
                    dayMovements.forEach(m => {
                        if (m.productId === p.id) {
                            // Revertir movimientos para calcular stock hist√≥rico
                            if (m.type === 'entrada') stock -= m.qty;
                            else stock += m.qty;
                        }
                    });
                    totalStock += Math.max(0, stock);
                });
                
                dates.push(date.getDate() + '/' + (date.getMonth() + 1));
                inventoryData.push(totalStock);
            }
            
            charts.inventory = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Total de unidades',
                        data: inventoryData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            // Gr√°fica de distribuci√≥n por categor√≠as
            const ctx4 = document.getElementById('categoryChart').getContext('2d');
            const modelStats = {};
            state.products.forEach(p => {
                const model = p.model || 'Sin modelo';
                if (!modelStats[model]) modelStats[model] = 0;
                modelStats[model] += p.stock || 0;
            });
            
            charts.category = new Chart(ctx4, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(modelStats),
                    datasets: [{
                        data: Object.values(modelStats),
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', 
                            '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function updateStockAlerts() {
            const lowStockProducts = state.products.filter(p => p.stock < (p.minStock || state.alertsConfig.alertThreshold));
            const alertsList = document.getElementById('stockAlertsList');
            document.getElementById('alertCount').textContent = lowStockProducts.length;
            
            if (lowStockProducts.length === 0) {
                alertsList.innerHTML = '<p style="color: var(--text-light);">‚úÖ No hay productos con stock cr√≠tico</p>';
            } else {
                alertsList.innerHTML = lowStockProducts.map(p => `
                    <div style="padding: 0.75rem; background: #fef2f2; border-left: 4px solid var(--danger); margin-bottom: 0.5rem; border-radius: var(--radius);">
                        <strong>${p.name}</strong> - ${p.color} - Talla: ${p.size || 'N/A'}
                        <br>
                        <span style="color: var(--danger);">Stock actual: ${p.stock} | M√≠nimo: ${p.minStock || state.alertsConfig.alertThreshold}</span>
                    </div>
                `).join('');
            }
        }

        function checkStockAlerts() {
            if (!state.alertsConfig.enabled) return;
            
            const newAlerts = state.products.filter(p => 
                p.stock < (p.minStock || state.alertsConfig.alertThreshold) &&
                !state.stockAlerts.some(a => a.productId === p.id)
            );
            
            newAlerts.forEach(product => {
                state.stockAlerts.push({
                    productId: product.id,
                    timestamp: Date.now()
                });
                
                notify(`‚ö†Ô∏è Stock bajo: ${product.name} (${product.stock} unidades)`, 'warning');
            });
            
            // Limpiar alertas viejas de productos que ya tienen stock
            state.stockAlerts = state.stockAlerts.filter(alert => {
                const product = state.products.find(p => p.id === alert.productId);
                return product && product.stock < (product.minStock || state.alertsConfig.alertThreshold);
            });
        }

        function toggleAlerts() {
            state.alertsConfig.enabled = document.getElementById('alertsEnabled').checked;
            saveState();
            notify(state.alertsConfig.enabled ? 'üîî Alertas activadas' : 'üîï Alertas desactivadas', 'info');
        }

        function updateAlertThreshold() {
            state.alertsConfig.alertThreshold = parseInt(document.getElementById('alertThreshold').value) || 5;
            saveState();
            checkStockAlerts();
        }

        // ==================== CIERRE MENSUAL ====================
        function updateLastCloseInfo() {
            const lastClose = state.monthlyClosed[state.monthlyClosed.length - 1];
            const infoDiv = document.getElementById('lastCloseInfo');
            
            if (lastClose) {
                infoDiv.innerHTML = `
                    <strong>√öltimo cierre:</strong> ${new Date(lastClose.date).toLocaleDateString('es-MX')}
                    <br>Movimientos archivados: ${lastClose.movementsCount}
                `;
            } else {
                infoDiv.innerHTML = 'No hay cierres mensuales anteriores';
            }
        }

        function openMonthlyClose() {
            if (!state.adminPassword) {
                notify('‚ö†Ô∏è Primero configura una contrase√±a', 'warning');
                return;
            }
            
            const password = prompt('üîê Contrase√±a para realizar cierre mensual:');
            if (password !== state.adminPassword) {
                if (password !== null) notify('‚ùå Contrase√±a incorrecta', 'error');
                return;
            }
            
            const now = new Date();
            const monthName = now.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });
            
            if (!confirm(`¬øRealizar cierre del mes ${monthName}?\n\nEsto:\n‚Ä¢ Exportar√° los movimientos del mes\n‚Ä¢ Crear√° un snapshot del inventario\n‚Ä¢ Limpiar√° movimientos antiguos\n‚Ä¢ Optimizar√° el rendimiento`)) {
                return;
            }
            
            performMonthlyClose();
        }

        function performMonthlyClose() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            
            // Filtrar movimientos del mes
            const monthMovements = state.movements.filter(m => 
                m.when >= startOfMonth.getTime() && m.when <= endOfMonth.getTime()
            );
            
            // Crear resumen del cierre
            const closeData = {
                id: generateId(),
                date: now.getTime(),
                month: now.getMonth(),
                year: now.getFullYear(),
                movementsCount: monthMovements.length,
                totalEntries: monthMovements.filter(m => m.type === 'entrada').reduce((sum, m) => sum + m.qty, 0),
                totalExits: monthMovements.filter(m => m.type === 'salida').reduce((sum, m) => sum + m.qty, 0),
                productsSnapshot: JSON.parse(JSON.stringify(state.products)),
                summary: {
                    totalProducts: state.products.length,
                    totalStock: state.products.reduce((sum, p) => sum + (p.stock || 0), 0),
                    totalValue: state.products.reduce((sum, p) => sum + ((p.price || 0) * (p.stock || 0)), 0)
                }
            };
            
            // Exportar movimientos del mes
            exportMovementsForMonth(monthMovements, now);
            
            // Exportar snapshot del inventario
            exportInventorySnapshot(now);
            
            // Agregar a cierres mensuales
            state.monthlyClosed.push(closeData);
            
            // Limpiar movimientos antiguos (mantener solo √∫ltimos 1000)
            state.movements = state.movements.slice(0, 1000);
            
            // Guardar estado
            saveState();
            
            notify(`‚úÖ Cierre mensual completado. ${monthMovements.length} movimientos archivados.`, 'success');
            updateLastCloseInfo();
        }

        function exportMovementsForMonth(movements, date) {
            const headers = ['when', 'barcode', 'product', 'size', 'color', 'model', 'type', 'qty', 'operator', 'platform', 'tracking', 'isReturn'];
            const rows = [headers];
            
            movements.forEach(m => {
                const product = state.products.find(p => p.id === m.productId);
                rows.push([
                    new Date(m.when).toISOString(),
                    m.barcode || '',
                    product?.name || '(eliminado)',
                    product?.size || '',
                    product?.color || '',
                    product?.model || '',
                    m.type,
                    m.qty,
                    m.operator || '',
                    m.platform || '',
                    m.tracking || '',
                    m.isReturn ? 'S√≠' : 'No'
                ]);
            });
            
            const csv = rows.map(row => 
                row.map(cell => {
                    const str = String(cell);
                    return str.includes(',') || str.includes('"') || str.includes('\n') ? 
                           `"${str.replace(/"/g, '""')}"` : str;
                }).join(',')
            ).join('\n');
            
            const BOM = '\uFEFF';
            const monthStr = date.toISOString().substring(0, 7);
            downloadFile(BOM + csv, `movimientos_${monthStr}.csv`, 'text/csv;charset=utf-8');
        }

        function exportInventorySnapshot(date) {
            const data = {
                date: date.toISOString(),
                products: state.products,
                summary: {
                    totalProducts: state.products.length,
                    totalStock: state.products.reduce((sum, p) => sum + (p.stock || 0), 0),
                    totalValue: state.products.reduce((sum, p) => sum + ((p.price || 0) * (p.stock || 0)), 0),
                    lowStockCount: state.products.filter(p => p.stock < (p.minStock || 0)).length
                }
            };
            
            const json = JSON.stringify(data, null, 2);
            const monthStr = date.toISOString().substring(0, 7);
            downloadFile(json, `inventario_snapshot_${monthStr}.json`, 'application/json');
        }

        // ==================== SINCRONIZACI√ìN ====================
        function generateSyncCode() {
            const syncData = {
                version: '1.0',
                timestamp: Date.now(),
                products: state.products,
                movements: state.movements.slice(0, 100), // Solo √∫ltimos 100 movimientos
                platforms: state.platforms,
                operator: state.operator,
                monthlyClosed: state.monthlyClosed
            };
            
            // Comprimir a base64
            const jsonStr = JSON.stringify(syncData);
            const compressed = btoa(encodeURIComponent(jsonStr));
            
            // Mostrar c√≥digo
            const codeDisplay = document.getElementById('syncCodeDisplay');
            codeDisplay.textContent = compressed.substring(0, 100) + '...[COPIADO AL PORTAPAPELES]';
            codeDisplay.style.display = 'block';
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(compressed).then(() => {
                notify('‚úÖ C√≥digo de sincronizaci√≥n copiado al portapapeles', 'success');
            });
        }

        function importSyncCode() {
            const code = document.getElementById('syncCodeInput').value.trim();
            if (!code) {
                notify('‚ö†Ô∏è Pega el c√≥digo de sincronizaci√≥n', 'warning');
                return;
            }
            
            try {
                // Descomprimir
                const jsonStr = decodeURIComponent(atob(code));
                const syncData = JSON.parse(jsonStr);
                
                if (!confirm('¬øReemplazar todos los datos con los del c√≥digo de sincronizaci√≥n?')) {
                    return;
                }
                
                // Importar datos
                state.products = syncData.products || [];
                state.movements = syncData.movements || [];
                state.platforms = syncData.platforms || [];
                state.monthlyClosed = syncData.monthlyClosed || [];
                
                saveState();
                updateStats();
                renderProducts();
                renderMovements();
                updateModelSummary();
                
                document.getElementById('syncCodeInput').value = '';
                notify('‚úÖ Datos sincronizados correctamente', 'success');
            } catch (error) {
                notify('‚ùå C√≥digo de sincronizaci√≥n inv√°lido', 'error');
                console.error('Error sincronizando:', error);
            }
        }

        // ==================== INICIALIZAR ====================
        window.addEventListener('DOMContentLoaded', init);
        
        // Limpiar recursos al salir
        window.addEventListener('beforeunload', () => {
            if (state.scannerActive) {
                closeMobileScanner();
            }
            if (state.rfidActive) {
                removeRFIDListener();
            }
        });
    </script>
</body>
</html>
